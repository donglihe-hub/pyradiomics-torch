import torch


# 和上面一样的常量，只是换成 torch.tensor
GRID_ANGLES_T = torch.tensor([
    [0, 0, 0],
    [0, 0, 1],
    [0, 1, 1],
    [0, 1, 0],
    [1, 0, 0],
    [1, 0, 1],
    [1, 1, 1],
    [1, 1, 0],
], dtype=torch.long)

VERT_LIST_T = torch.tensor([
    [0.0, 0.0, 0.5],
    [0.0, 0.5, 1.0],
    [0.0, 1.0, 0.5],
    [0.0, 0.5, 0.0],
    [1.0, 0.0, 0.5],
    [1.0, 0.5, 1.0],
    [1.0, 1.0, 0.5],
    [1.0, 0.5, 0.0],
    [0.5, 0.0, 0.0],
    [0.5, 0.0, 1.0],
    [0.5, 1.0, 1.0],
    [0.5, 1.0, 0.0],
], dtype=torch.float64)

POINTS_EDGES_T = torch.tensor([[6, 4, 3], [6, 7, 11]], dtype=torch.long)

TRI_TABLE_T = torch.tensor([
    [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [0, 8, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [1, 9, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [1, 8, 3, 1, 9, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [1, 2, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [0, 8, 3, 1, 2, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [9, 2, 10, 0, 2, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [2, 8, 3, 2, 10, 8, 10, 9, 8, -1, -1, -1, -1, -1, -1, -1],
    [11, 2, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [11, 2, 0, 0, 8, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [1, 9, 0, 11, 2, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [11, 2, 1, 1, 9, 11, 9, 8, 11, -1, -1, -1, -1, -1, -1, -1],
    [3, 10, 1, 11, 10, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [10, 1, 0, 0, 8, 10, 8, 11, 10, -1, -1, -1, -1, -1, -1, -1],
    [9, 0, 3, 3, 11, 9, 11, 10, 9, -1, -1, -1, -1, -1, -1, -1],
    [9, 8, 10, 11, 10, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [4, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [0, 4, 3, 4, 7, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [1, 9, 0, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [1, 9, 4, 1, 4, 7, 1, 7, 3, -1, -1, -1, -1, -1, -1, -1],
    [1, 2, 10, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [3, 4, 7, 3, 0, 4, 1, 2, 10, -1, -1, -1, -1, -1, -1, -1],
    [9, 2, 10, 9, 0, 2, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1],
    [2, 10, 9, 2, 9, 7, 2, 7, 3, 4, 7, 9, -1, -1, -1, -1],
    [4, 7, 8, 11, 2, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [11, 4, 7, 11, 2, 4, 2, 0, 4, -1, -1, -1, -1, -1, -1, -1],
    [1, 9, 0, 4, 7, 8, 11, 2, 3, -1, -1, -1, -1, -1, -1, -1],
    [4, 7, 11, 9, 4, 11, 11, 2, 9, 1, 9, 2, -1, -1, -1, -1],
    [3, 10, 1, 11, 10, 3, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1],
    [11, 10, 1, 1, 4, 11, 1, 0, 4, 4, 7, 11, -1, -1, -1, -1],
    [4, 7, 8, 9, 0, 3, 3, 11, 9, 11, 10, 9, -1, -1, -1, -1],
    [4, 7, 11, 4, 11, 9, 9, 11, 10, -1, -1, -1, -1, -1, -1, -1],
    [9, 5, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [9, 5, 4, 0, 8, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [0, 5, 4, 0, 1, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [8, 5, 4, 8, 3, 5, 3, 1, 5, -1, -1, -1, -1, -1, -1, -1],
    [1, 2, 10, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [0, 8, 3, 1, 2, 10, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1],
    [2, 10, 5, 5, 4, 2, 2, 4, 0, -1, -1, -1, -1, -1, -1, -1],
    [2, 10, 5, 3, 2, 5, 3, 5, 4, 8, 3, 4, -1, -1, -1, -1],
    [9, 5, 4, 11, 2, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [11, 2, 0, 0, 8, 11, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1],
    [0, 5, 4, 0, 1, 5, 11, 2, 3, -1, -1, -1, -1, -1, -1, -1],
    [2, 1, 5, 2, 5, 8, 11, 2, 8, 5, 4, 8, -1, -1, -1, -1],
    [3, 10, 1, 11, 10, 3, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1],
    [5, 4, 9, 10, 1, 0, 0, 8, 10, 8, 11, 10, -1, -1, -1, -1],
    [5, 4, 0, 5, 0, 11, 10, 5, 11, 11, 0, 3, -1, -1, -1, -1],
    [5, 4, 8, 10, 5, 8, 11, 10, 8, -1, -1, -1, -1, -1, -1, -1],
    [7, 8, 9, 5, 7, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [3, 0, 9, 5, 3, 9, 3, 5, 7, -1, -1, -1, -1, -1, -1, -1],
    [7, 8, 0, 0, 1, 7, 7, 1, 5, -1, -1, -1, -1, -1, -1, -1],
    [1, 5, 7, 1, 7, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [7, 8, 9, 5, 7, 9, 1, 2, 10, -1, -1, -1, -1, -1, -1, -1],
    [1, 2, 10, 3, 0, 9, 3, 9, 5, 3, 5, 7, -1, -1, -1, -1],
    [0, 2, 8, 8, 2, 5, 8, 5, 7, 2, 10, 5, -1, -1, -1, -1],
    [2, 10, 5, 2, 5, 3, 3, 5, 7, -1, -1, -1, -1, -1, -1, -1],
    [5, 7, 9, 7, 8, 9, 11, 2, 3, -1, -1, -1, -1, -1, -1, -1],
    [5, 7, 9, 9, 7, 2, 2, 0, 9, 11, 2, 7, -1, -1, -1, -1],
    [11, 2, 3, 0, 1, 8, 1, 7, 8, 1, 5, 7, -1, -1, -1, -1],
    [2, 1, 11, 1, 7, 11, 1, 5, 7, -1, -1, -1, -1, -1, -1, -1],
    [7, 8, 9, 5, 7, 9, 3, 10, 1, 11, 10, 3, -1, -1, -1, -1],
    [5, 7, 0, 5, 0, 9, 7, 11, 0, 10, 1, 0, 11, 10, 0, -1],
    [11, 10, 0, 0, 3, 11, 10, 5, 0, 0, 7, 8, 5, 7, 0, -1],
    [11, 10, 5, 5, 7, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [6, 5, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [0, 8, 3, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [1, 9, 0, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [1, 8, 3, 1, 9, 8, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1],
    [1, 6, 5, 1, 2, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [1, 6, 5, 1, 2, 6, 0, 8, 3, -1, -1, -1, -1, -1, -1, -1],
    [9, 6, 5, 9, 0, 6, 0, 2, 6, -1, -1, -1, -1, -1, -1, -1],
    [5, 9, 8, 5, 8, 2, 5, 2, 6, 8, 3, 2, -1, -1, -1, -1],
    [11, 2, 3, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [11, 2, 0, 0, 8, 11, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1],
    [1, 9, 0, 11, 2, 3, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1],
    [11, 2, 1, 1, 9, 11, 9, 8, 11, 6, 5, 10, -1, -1, -1, -1],
    [6, 3, 11, 6, 5, 3, 5, 1, 3, -1, -1, -1, -1, -1, -1, -1],
    [0, 8, 11, 0, 11, 5, 0, 5, 1, 5, 11, 6, -1, -1, -1, -1],
    [6, 3, 11, 0, 3, 6, 0, 6, 5, 0, 5, 9, -1, -1, -1, -1],
    [6, 5, 9, 6, 9, 11, 11, 9, 8, -1, -1, -1, -1, -1, -1, -1],
    [4, 7, 8, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [0, 4, 3, 4, 7, 3, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1],
    [1, 9, 0, 4, 7, 8, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1],
    [1, 9, 4, 1, 4, 7, 1, 7, 3, 6, 5, 10, -1, -1, -1, -1],
    [4, 7, 8, 1, 6, 5, 1, 2, 6, -1, -1, -1, -1, -1, -1, -1],
    [0, 4, 3, 4, 7, 3, 1, 6, 5, 1, 2, 6, -1, -1, -1, -1],
    [4, 7, 8, 9, 6, 5, 9, 0, 6, 0, 2, 6, -1, -1, -1, -1],
    [7, 3, 9, 4, 7, 9, 3, 2, 9, 5, 9, 6, 2, 6, 9, -1],
    [11, 2, 3, 4, 7, 8, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1],
    [11, 4, 7, 11, 2, 4, 2, 0, 4, 6, 5, 10, -1, -1, -1, -1],
    [1, 9, 0, 11, 2, 3, 4, 7, 8, 6, 5, 10, -1, -1, -1, -1],
    [4, 7, 11, 9, 4, 11, 11, 2, 9, 1, 9, 2, 6, 5, 10, -1],
    [4, 7, 8, 6, 3, 11, 6, 5, 3, 5, 1, 3, -1, -1, -1, -1],
    [5, 1, 11, 5, 11, 6, 1, 0, 11, 4, 7, 11, 0, 4, 11, -1],
    [4, 7, 8, 6, 3, 11, 0, 3, 6, 0, 6, 5, 0, 5, 9, -1],
    [6, 5, 9, 6, 9, 11, 4, 7, 9, 7, 11, 9, -1, -1, -1, -1],
    [10, 4, 9, 6, 4, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [10, 4, 9, 6, 4, 10, 0, 8, 3, -1, -1, -1, -1, -1, -1, -1],
    [0, 1, 10, 10, 6, 0, 6, 4, 0, -1, -1, -1, -1, -1, -1, -1],
    [1, 8, 3, 1, 6, 8, 8, 6, 4, 6, 1, 10, -1, -1, -1, -1],
    [1, 4, 9, 1, 2, 4, 2, 6, 4, -1, -1, -1, -1, -1, -1, -1],
    [1, 4, 9, 1, 2, 4, 2, 6, 4, 0, 8, 3, -1, -1, -1, -1],
    [0, 2, 4, 4, 2, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [8, 3, 2, 8, 2, 4, 4, 2, 6, -1, -1, -1, -1, -1, -1, -1],
    [11, 2, 3, 10, 4, 9, 6, 4, 10, -1, -1, -1, -1, -1, -1, -1],
    [11, 2, 0, 0, 8, 11, 10, 4, 9, 6, 4, 10, -1, -1, -1, -1],
    [11, 2, 3, 0, 1, 10, 10, 6, 0, 6, 4, 0, -1, -1, -1, -1],
    [6, 4, 1, 6, 1, 10, 1, 4, 8, 11, 2, 1, 1, 8, 11, -1],
    [9, 6, 4, 3, 6, 9, 1, 3, 9, 11, 6, 3, -1, -1, -1, -1],
    [1, 8, 11, 0, 8, 1, 11, 6, 1, 1, 4, 9, 6, 4, 1, -1],
    [6, 3, 11, 0, 3, 6, 6, 4, 0, -1, -1, -1, -1, -1, -1, -1],
    [8, 6, 4, 6, 8, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [6, 7, 10, 7, 8, 10, 8, 9, 10, -1, -1, -1, -1, -1, -1, -1],
    [6, 7, 10, 0, 10, 7, 0, 9, 10, 0, 7, 3, -1, -1, -1, -1],
    [6, 7, 10, 1, 10, 7, 1, 7, 8, 0, 1, 8, -1, -1, -1, -1],
    [6, 7, 10, 1, 10, 7, 1, 7, 3, -1, -1, -1, -1, -1, -1, -1],
    [1, 2, 6, 1, 6, 8, 1, 8, 9, 6, 7, 8, -1, -1, -1, -1],
    [2, 6, 9, 1, 2, 9, 6, 7, 9, 3, 0, 9, 7, 3, 9, -1],
    [0, 7, 8, 7, 0, 6, 6, 0, 2, -1, -1, -1, -1, -1, -1, -1],
    [2, 7, 3, 2, 6, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [11, 2, 3, 6, 7, 10, 7, 8, 10, 8, 9, 10, -1, -1, -1, -1],
    [2, 0, 7, 11, 2, 7, 0, 9, 7, 6, 7, 10, 9, 10, 7, -1],
    [6, 7, 10, 1, 10, 7, 1, 7, 8, 0, 1, 8, 11, 2, 3, -1],
    [11, 2, 1, 1, 7, 11, 10, 6, 1, 1, 6, 7, -1, -1, -1, -1],
    [8, 9, 6, 6, 7, 8, 1, 6, 9, 11, 6, 3, 1, 3, 6, -1],
    [0, 9, 1, 6, 7, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
    [0, 7, 8, 7, 0, 6, 0, 3, 11, 11, 6, 0, -1, -1, -1, -1],
    [6, 7, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
], dtype=torch.long)


def calculate_mesh_diameter_torch(vertices: torch.Tensor) -> torch.Tensor:
    """
    vertices: (N, 3) float64 tensor
    返回: (4,) float64 tensor
    """
    if vertices.numel() == 0:
        return torch.zeros(4, dtype=torch.float64, device=vertices.device)

    v = vertices.to(dtype=torch.float64)
    N = v.shape[0]

    d0 = d1 = d2 = d3 = 0.0

    for i in range(N):
        a = v[i]         # (3,)
        b = v[:i]        # (i,3)

        if b.numel() == 0:
            continue

        diffs = a - b            # (i,3)
        sq = torch.sum(diffs * diffs, dim=1)  # (i,)

        same_x = (b[:, 0] == a[0])
        same_y = (b[:, 1] == a[1])
        same_z = (b[:, 2] == a[2])

        if torch.any(same_x):
            d0 = max(d0, float(torch.max(sq[same_x])))
        if torch.any(same_y):
            d1 = max(d1, float(torch.max(sq[same_y])))
        if torch.any(same_z):
            d2 = max(d2, float(torch.max(sq[same_z])))

        d3 = max(d3, float(torch.max(sq)))

    return torch.sqrt(torch.tensor([d0, d1, d2, d3], dtype=torch.float64, device=v.device))


def calculate_coefficients_torch(mask: torch.Tensor,
                                 spacing: torch.Tensor):
    """
    PyTorch 版本的 calculate_coefficients。
    mask: (Z, Y, X) tensor，非零视为 segmentation
    spacing: (3,) tensor，对应 [dz, dy, dx]

    返回: surface_area (float), volume (float), diameters (torch.Tensor of shape (4,))
    """
    if not torch.is_tensor(mask):
        mask = torch.tensor(mask)
    if not torch.is_tensor(spacing):
        spacing = torch.tensor(spacing, dtype=torch.float64)

    assert mask.dim() == 3, "mask must be 3D"
    assert spacing.numel() == 3, "spacing must have length 3"

    mask = mask.to(dtype=torch.bool)  # 用 bool 即可
    spacing = spacing.to(dtype=torch.float64)

    Z, Y, X = mask.shape
    size = (Z, Y, X)

    surface_area = 0.0
    volume = 0.0

    vertices = []
    device = mask.device

    for iz in range(Z - 1):
        for iy in range(Y - 1):
            for ix in range(X - 1):
                cube_idx = 0
                for a_idx in range(8):
                    dz, dy, dx = GRID_ANGLES_T[a_idx].tolist()
                    z = iz + dz
                    y = iy + dy
                    x = ix + dx
                    if mask[z, y, x]:
                        cube_idx |= (1 << a_idx)

                if cube_idx & 0x80:
                    cube_idx ^= 0xFF
                    sign_correction = -1.0
                else:
                    sign_correction = 1.0

                # 顶点记录
                for t in range(3):
                    pt_idx = int(POINTS_EDGES_T[0, t])
                    vert_idx = int(POINTS_EDGES_T[1, t])
                    if cube_idx & (1 << pt_idx):
                        vz, vy, vx = VERT_LIST_T[vert_idx].tolist()
                        vertices.append([
                            (iz + vz) * float(spacing[0]),
                            (iy + vy) * float(spacing[1]),
                            (ix + vx) * float(spacing[2]),
                        ])

                if cube_idx == 0:
                    continue

                tri_row = TRI_TABLE_T[cube_idx]
                t_idx = 0
                while tri_row[3 * t_idx] >= 0:
                    a = torch.tensor([iz, iy, ix], dtype=torch.float64, device=device)
                    b = a.clone()
                    c = a.clone()

                    for d in range(3):
                        a[d] += VERT_LIST_T[tri_row[3 * t_idx + 0], d]
                        b[d] += VERT_LIST_T[tri_row[3 * t_idx + 1], d]
                        c[d] += VERT_LIST_T[tri_row[3 * t_idx + 2], d]

                        a[d] *= spacing[d]
                        b[d] *= spacing[d]
                        c[d] *= spacing[d]

                    # 体积
                    ab = torch.tensor([
                        (a[1] * b[2]) - (b[1] * a[2]),
                        (a[2] * b[0]) - (b[2] * a[0]),
                        (a[0] * b[1]) - (b[0] * a[1]),
                    ], dtype=torch.float64, device=device)

                    volume += sign_correction * float(torch.dot(ab, c))

                    # 表面积
                    a_rel = a - c
                    b_rel = b - c

                    ab2 = torch.tensor([
                        (a_rel[1] * b_rel[2]) - (b_rel[1] * a_rel[2]),
                        (a_rel[2] * b_rel[0]) - (b_rel[2] * a_rel[0]),
                        (a_rel[0] * b_rel[1]) - (b_rel[0] * a_rel[1]),
                    ], dtype=torch.float64, device=device)

                    surface_area += 0.5 * float(torch.linalg.norm(ab2))

                    t_idx += 1

    volume /= 6.0

    if len(vertices) > 0:
        vertices_t = torch.tensor(vertices, dtype=torch.float64, device=device)
        diameters = calculate_mesh_diameter_torch(vertices_t)
    else:
        diameters = torch.zeros(4, dtype=torch.float64, device=device)

    return surface_area, volume, diameters